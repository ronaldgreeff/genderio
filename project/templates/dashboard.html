{% extends 'base.html' %}

{% block content %}

<!-- MODAL -->
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Crop the image</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="img-container">
          <img id="hidden_image" src="">
        </div>
        <!-- <div class="preview" id="file" style="height: 256px; width: 256px;"></div> -->
      </div>
      <div class="modal-baby-age">
        <h6>How old is baby in the picture?</h6>
        <label for="weeks-old">
          <p>weeks</p>
          <input type="text" name="weeks-old" value="0" id="baby-weeks-old">
        </label>
        <label for="days-old">
          <p>days</p>
          <input type="text" name="days-old" value="0" id="baby-days-old">
        </label>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="crop">Crop</button>
      </div>
    </div>
  </div>
</div>

{% for baby in babies %}

<div class="baby-wrapper" data-id={{ baby.baby.id }}>

  <form method="POST" action="/update_baby" >
    <div class="name">
      {{ baby.updateform.name.label }}
      {{ baby.updateform.name(
        id="update-name-" + baby.baby.id|string,
        value=baby.baby.name
      ) }}
    </div>
    <div class="dob">
      {{ baby.updateform.dob.label }}
      {{ baby.updateform.dob(
        id="update-dob-" + baby.baby.id|string,
        value=baby.baby.dob,
        class="pickdate",
      ) }}
    </div>
    <div class="id">
      {{ baby.updateform.id(id="update-id-" + baby.baby.id|string) }}
    </div>
    <div class="submit-button">
      {{ baby.updateform.update(id="update-button-" + baby.baby.id|string) }}
    </div>
  </form>

  <div class="image-inputs-wrapper" id="image-input-{{ loop.index0 }}">
    <label class="label" id="upload_input-{{ loop.index0 }}-0" data-id={{ baby.baby.id }}>
      <img class="rounded" id="upload_thumbmail-{{ loop.index0 }}-0" src={{ baby.babypics.0 if baby.babypics.0 else "static/img/0.png" }} alt="baby {{ loop.index0 }} upload thumbmail 0">
      <input type="file" class="form-control-file sr-only" id="input-{{ loop.index0 }}-0" name="image-{{ loop.index0 }}-0" accept="image/*">
      <!-- <img id="upload-image" src="" alt="upload-image" style="display: none"> -->
    </label>
    <label class="label" id="upload_input-{{ loop.index0 }}-1" data-id={{ baby.baby.id }}>
      <img class="rounded" id="upload_thumbmail-{{ loop.index0 }}-1" src={{ baby.babypics.1 if baby.babypics.1 else "static/img/1.png" }} alt="baby {{ loop.index0 }} upload thumbmail 1">
      <input type="file" class="form-control-file sr-only" id="input-{{ loop.index0 }}-1" name="image-{{ loop.index0 }}-1" accept="image/*">
      <!-- <img id="upload-image" src="" alt="upload-image" style="display: none"> -->
    </label>
    <label class="label" id="upload_input-{{ loop.index0 }}-2" data-id={{ baby.baby.id }}>
      <img class="rounded" id="upload_thumbmail-{{ loop.index0 }}-2" src={{ baby.babypics.2 if baby.babypics.2 else "static/img/2.png" }} alt="baby {{ loop.index0 }} upload thumbmail 2">
      <input type="file" class="form-control-file sr-only" id="input-{{ loop.index0 }}-2" name="image-{{ loop.index0 }}-2" accept="image/*">
      <!-- <img id="upload-image" src="" alt="upload-image" style="display: none"> -->
    </label>
    <label class="label" id="upload_input-{{ loop.index0 }}-3" data-id={{ baby.baby.id }}>
      <img class="rounded" id="upload_thumbmail-{{ loop.index0 }}-3" src={{ baby.babypics.3 if baby.babypics.3 else "static/img/3.png" }} alt="baby {{ loop.index0 }} upload thumbmail 3">
      <input type="file" class="form-control-file sr-only" id="input-{{ loop.index0 }}-3" name="image-{{ loop.index0 }}-3" accept="image/*">
      <!-- <img id="upload-image" src="" alt="upload-image" style="display: none"> -->
    </label>
    <label class="label" id="upload_input-{{ loop.index0 }}-4" data-id={{ baby.baby.id }}>
      <img class="rounded" id="upload_thumbmail-{{ loop.index0 }}-4" src={{ baby.babypics.4 if baby.babypics.4 else "static/img/4.png" }} alt="baby {{ loop.index0 }} upload thumbmail 4">
      <input type="file" class="form-control-file sr-only" id="input-{{ loop.index0 }}-4" name="image-{{ loop.index0 }}-4" accept="image/*">
      <!-- <img id="upload-image" src="" alt="upload-image" style="display: none"> -->
    </label>
    <label class="label" id="upload_input-{{ loop.index0 }}-5" data-id={{ baby.baby.id }}>
      <img class="rounded" id="upload_thumbmail-{{ loop.index0 }}-5" src={{ baby.babypics.5 if baby.babypics.5 else "static/img/5.png" }} alt="baby {{ loop.index0 }} upload thumbmail 5">
      <input type="file" class="form-control-file sr-only" id="input-{{ loop.index0 }}-5" name="image-{{ loop.index0 }}-5" accept="image/*">
      <!-- <img id="upload-image" src="" alt="upload-image" style="display: none"> -->
    </label>
  </div>
</div>

<div class="predict-result-wrapper">
  <h1>BOY</h1>
</div>

<div class="predict-button">
  <button type="button" class="btn btn-primary" name="button" id="predict-button-{{ baby.baby.id }}">Predict</button>
</div>
{% endfor %}

<!-- NewBabyForm -->
<form method="POST" action="/dashboard">
  {{ new.csrf_token }}
  <fieldset class="name">
    {{ new.name.label }}
    {{ new.name(placeholder="Baby's Name") }}
  </fieldset>
  <fieldset class="dob">
    {{ new.dob.label }}
    {{ new.dob(class="pickdate") }}
  </fieldset>
  <div class="submit-button">
    {{ new.add }}
  </div>
</form>

<!-- JS unique to Dashboard.html -->
{% if babies %}
<script src="static/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript">

  // PREDICTION
  /////////////////////////////////

  // $('.predict-button').children() {
  //
  // }

  // IMAGE UPLOAD
  /////////////////////////////////

  const $modal = $('#modal');
  const hidden_image = document.getElementById('hidden_image');
  // on modal shown/hidden create/destroy cropper
  $modal.on('shown.bs.modal', function () {
    cropper = new Cropper(hidden_image, {
      viewMode: 2,
      dragMode: 'move',
      initialAspectRatio: 16 / 9,
      preview: '.preview',
      scalable: false,
      zoomable: false,
      zoomOnTouch: false,
      center: false,
      guides: false,
    });
  }).on('hidden.bs.modal', function () {
    cropper.destroy();
    cropper = null;
  });

  // on crop
  $('#modal #crop').on('click', function() {
    var initialImage;
    var canvas;

    $modal.modal('hide');

    if (cropper) {
      let canvas = cropper.getCroppedCanvas();
      let upload_img = document.getElementById(hidden_image.dataset.backref);
      let baby_id = $(upload_img).parents().eq(2)[0].dataset.id
      let weeks_old = document.getElementById('baby-weeks-old');
      let days_old = document.getElementById('baby-days-old');

      initialImage = upload_img.src;
      // upload_img.src = canvas.toDataURL();

      canvas.toBlob(function(blob) {

        let formData = new FormData();
        formData.append('imageType', blob.type);
        formData.append("image", blob);
        formData.append("baby_id", baby_id);
        formData.append("weeks", weeks_old);
        formData.append("days", days_old);

        $.ajax('/upload_img', {
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,

            success: function (data) {
              console.log(data)
              if (data.success == true) {
                upload_img.src = data.src;
              }
              else {
                console.log(data.error) // todo
              }
            },

            error: function (xhr, ajaxOptions, thrownError) {
              upload_img.src = initialImage;
              console.log(xhr.status);
              console.log(thrownError);
            },
          });

      });
    };
  });

  $('.image-inputs-wrapper').children().click(function(){
    let baby_id = this.dataset.id;
    let upload_img = this.firstElementChild;
    let input = upload_img.nextElementSibling;
    let cropper;

    // upon image upload, read it and send to hidden_image.src, then show modal
    input.addEventListener('change', function(e) {
      var files = e.target.files;
      var done = function(url) {
        input.value = '';
        hidden_image.src = url;
        hidden_image.setAttribute("data-backref", upload_img.id);
        $modal.modal('show');
      };
      var reader;
      var file;
      var url;

      if (files && files.length > 0) {
        file = files[0]

        if (URL) {
          done(URL.createObjectURL(file));
        } else if (FileReader) {
          reader = new FileReader();
          reader.onload = function(e) {
            done(reader.result);
          };
          reader.readAsDataURL(file);
        }
      }
    });

  });

</script>
{% endif %}

{% endblock %}
